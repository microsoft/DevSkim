# Azure Pipelines
# https://aka.ms/yaml

name: DevSkim_CLI_PR_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
trigger: none
pr:
  branches:
    include:
    - main

resources:
  repositories:
    - repository: templates
      type: git
      name: SecurityEngineering/OSS-Tools-Pipeline-Templates
      # ref: refs/tags/v1.1.1
      ref: refs/heads/gfs/UpdateTemplates
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

variables:
  BuildConfiguration: 'Release'
  DotnetVersion: '8.0.x'

extends:
  # The pipeline extends the 1ES PT which will inject different SDL and compliance tasks.
  # For non-production pipelines, use "Unofficial" as defined below.
  # For productions pipelines, use "Official".
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:
    # Update the pool with your team's 1ES hosted pool.
    pool:
      name: MSSecurity-1ES-Build-Agents-Pool  # Name of your hosted pool 
      image: MSSecurity-1ES-Windows-2022  # Name of the image in your pool. If not specified, first image of the pool is used
      os: windows  # OS of the image. This value cannot be a variable. Allowed values: windows, linux, macOS
    stages:
    - stage: Test
      jobs:
      - template: dotnet-test-job.yml@templates
        parameters:
          jobName: 'dotnet_test_windows'
          dotnetVersions: ['6.0.x','7.0.x','8.0.x']
          projectPath: 'DevSkim-DotNet/Microsoft.DevSkim.Tests/Microsoft.DevSkim.Tests.csproj'
          poolName: MSSecurity-1ES-Build-Agents-Pool
          poolImage: MSSecurity-1ES-Windows-2022  # Name of the image in your pool. If not specified, first image of the pool is used
          poolOs: windows  # OS of the image. This value cannot be a variable. Allowed values: windows, linux, macOS
      - template: dotnet-test-job.yml@templates
        parameters:
          jobName: 'dotnet_test_ubuntu'
          dotnetVersions: ['6.0.x','7.0.x','8.0.x']
          poolName: MSSecurity-1ES-Build-Agents-Pool  # Name of your hosted pool 
          poolImage: MSSecurity-1ES-Ubuntu-2204  # Name of the image in your pool. If not specified, first image of the pool is used
          poolOs: linux  # OS of the image. This value cannot be a variable. Allowed values: windows, linux, macOS
          projectPath: 'DevSkim-DotNet/Microsoft.DevSkim.Tests/Microsoft.DevSkim.Tests.csproj'          
    - stage: Build
      dependsOn:
      - Test
      jobs:
      - template: dotnet-publish-linux-mac-job.yml@templates
        parameters:
          buildConfiguration: 'Release'
          dotnetVersion: ${{ variables.DotnetVersion }}
          projectPath: 'DevSkim-DotNet/Microsoft.DevSkim.CLI/Microsoft.DevSkim.CLI.csproj'
          projectName: 'DevSkim_CLI'
          exePath: 'devskim'
          artifactName: 'linux-mac-archive'
          manifestName: 'linux-mac-manifest'
          preBuild:
          - template: nbgv-set-version-steps.yml@templates
      - template: dotnet-publish-win-netcore-job.yml@templates
        parameters:
          buildConfiguration: 'Release'
          dotnetVersion: ${{ variables.DotnetVersion }}
          projectPath: 'DevSkim-DotNet/Microsoft.DevSkim.CLI/Microsoft.DevSkim.CLI.csproj'
          projectName: 'DevSkim_CLI'
          artifactName: 'win-netcore-archive'
          manifestName: 'win-netcore-manifest'
          preBuild:
          - template: nbgv-set-version-steps.yml@templates
      - template: nuget-build-job.yml@templates
        parameters:
          jobName: 'pack_lib'
          buildConfiguration: 'Release'
          dotnetVersion: ${{ variables.DotnetVersion }}
          projectPath: 'DevSkim-DotNet/Microsoft.DevSkim/Microsoft.DevSkim.csproj'
          projectName: 'DevSkim_Lib'
          artifactName: 'nuget-lib-archive'
          manifestName: 'nuget-lib-manifest'
          preBuild:
          - template: nbgv-set-version-steps.yml@templates
      - template: nuget-build-job.yml@templates
        parameters:
          jobName: 'pack_cli'
          buildConfiguration: 'Release'
          dotnetVersion: ${{ variables.DotnetVersion }}
          projectPath: 'DevSkim-DotNet/Microsoft.DevSkim.CLI/Microsoft.DevSkim.CLI.csproj'
          projectName: 'DevSkim_CLI'
          artifactName: 'nuget-cli-archive'
          manifestName: 'nuget-cli-manifest'
          preBuild:
          - template: nbgv-set-version-steps.yml@templates
